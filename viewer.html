<!DOCTYPE html>
<html lang="en" ng-app="harvey">
<head>
	<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
	<style>
		#method {
			width: 95px;
		}

		#protocol {
			width: 80px;
		}

		#resource {
			width: 400px;
		}
		#requestBody {
			height: 75px;
			width: 500px;
			border-radius: 4px;
			border-color: rgb(204, 204, 204);
			border-style: solid;
			border-width: 1px;
		}
		#invalidjson {
			display: none;
		}
		.qs-name, .header-name {
			width: 100px;
		}
		.templateName {
			margin: 2px;
			padding: 3px;
			border-radius: 5px;
			background-color: lightblue;
		}

		
		.ace_scrollbar {
			display: none !important;
		}
	</style>
</head>
<body>
<div ng-controller="ProjectListCtrl">
	<h2>Tests</h2>
	<span ng-repeat="test in tests">
		<a href="#/tests/{{test.id}}">{{test.id}}</a>
	</span>
</div>

<div ng-view>
</div>
</body>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
<script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js?lan=javascript"></script>
<script src="http://rawgithub.com/ajaxorg/ace-builds/master/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="http://jsbeautifier.org/js/lib/beautify.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.6/angular.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
<script>
var editor;

function wireupForm(bodyText, bodyCallback) {

	if(_.isObject(bodyText)) bodyText = js_beautify(JSON.stringify(bodyText));

	$('#resource').typeahead({
		"source": ["courseId", "courseItemId", "userId", "gradeId"],
		"matcher": function(item) {
			var cursorPosition = doGetCaretPosition(document.getElementById('resource'));
			var braceOpenPosition = this.query.lastIndexOf('${', cursorPosition);
			var braceClosedPosition = this.query.lastIndexOf('}', cursorPosition);
			if(cursorPosition>= 2 && braceOpenPosition > -1 && braceOpenPosition > braceClosedPosition) {
				var partialVarName = this.query.substring(braceOpenPosition + 2, cursorPosition);

				if(partialVarName === "" || item.indexOf(partialVarName) === 0) {
					return true;
				}
			}

			return false;
		},
		"updater": function(item) {
			var cursorPosition = doGetCaretPosition(document.getElementById('resource'));
			var braceOpenPosition = this.query.lastIndexOf('${', cursorPosition);
			var braceClosedPosition = this.query.indexOf('}', cursorPosition);
			var nextBraceOpenPosition = this.query.indexOf('${', cursorPosition);
			if(nextBraceOpenPosition === -1) nextBraceOpenPosition = 99999999;
			var endPosition = (braceClosedPosition !== -1 && braceClosedPosition < nextBraceOpenPosition) ? braceClosedPosition + 1 : cursorPosition;
			var preString = this.query.substr(0, braceOpenPosition);
			var postString = this.query.substr(endPosition);
			var updatedText = preString + '${' + item + '}' + postString;
			return updatedText;
		}
	});

	editor = ace.edit("requestBody");
	//editor.setReadOnly(true);
	editor.renderer.setShowGutter(false);
	editor.setHighlightActiveLine(false);
    editor.setTheme("ace/theme/clouds");
    editor.getSession().setMode("ace/mode/json");

    editor.getSession().on('change', function(e) {
		//Save the content
		bodyCallback(editor.getValue());
    
		//Set the editor height
		var lineCount = editor.session.getLength();
		if(lineCount < 5) lineCount = 5;
		document.getElementById('requestBody').style.height = (lineCount * 15) + 'px';;
		editor.resize();
		
		//Determine if the current content is valid
		var text = editor.getValue();
		var valid = true;
		try {
			JSON.parse(text);
		}
		catch(error) {
			valid = false;
		}
		if(valid) {
			$('#invalidjson').hide();
		}
		else {
			$('#invalidjson').show();
		}
	});

	editor.setValue(bodyText);

}

var app = angular.module('harvey', []).
  config(['$routeProvider', function($routeProvider) {
    $routeProvider.when('/tests/:testId', {controller:EditTestCtrl, templateUrl:'editTest.html'});
}]);

app.directive('ngBgColorOnEmpty', function () {
    return function (scope, element, attrs) {
		scope.$watch(element.context.attributes['ng-bg-color-on-empty'].value, function (value) {
			if (value) {
				element.context.style.backgroundColor = 'transparent';
			} else {
				var inheritedFrom = element.context.attributes['data-inherited-from'].value;
				var index = currentTest.request.templates.indexOf(inheritedFrom);
				if(index > -1) {
					element.context.style.backgroundColor = _colors[index];
				}
				else {
					element.context.style.backgroundColor = 'transparent';
				}
			}
		});
    }
});

var _colors = ['lightblue', 'lightyellow', 'lightgreen', 'lightred'];

  
function ProjectListCtrl($scope) {
	$scope.tests = data.tests;
}

var currentTest = null;
function EditTestCtrl($scope, $routeParams) {

	for(var i=0; i<data.tests.length; i++) {
		if(data.tests[i].id == $routeParams.testId) {
			$scope.test = currentTest = data.tests[i];
		}
	}

	//Assign template colors
	$scope.color = {};
	for(var i=0; i<$scope.test.request.templates.length; i++) {
		$scope.color[$scope.test.request.templates[i]] = _colors[i];
	}

	$scope.getColor = function(index) {
		return _colors[index];
	}

	$scope.updateBgColor = function(field) {
		if(field.value == field.inheritedValue) {
			field.bgcolor = $scope.color[field.inheritedFrom] || transparent;
		}
		else {
			field.bgcolor = 'transparent';
		}
	}

	$scope.updateHeaderBgColor = function(field) {
		if(field.key == field.inheritedKey && field.value == field.inheritedValue) {
			field.bgcolor = $scope.color[field.inheritedFrom] || transparent;
		}
		else {
			field.bgcolor = 'transparent';
		}
	}


	$scope.addHeader = function() {
		if(!$scope.test.request.headers) $scope.test.request.headers = [];
		
		$scope.test.request.headers.push({'key': '', 'value': ''});
	}

	$scope.removeHeader = function(index) {
		$scope.test.request.headers.splice(index, 1);
	}

	$scope.addQuerystring = function() {
		if(!$scope.test.request.querystring) $scope.test.request.querystring = [];

		$scope.test.request.querystring.push({'key': '', 'value': ''});
	}

	$scope.removeQuerystring = function(index) {
		delete $scope.test.request.querystring.splice(index, 1);
	}

	$scope.updateModelWithBody = function(bodyText) {
		$scope.test.request.body = bodyText;
	}


	wireupForm($scope.test.request.body, $scope.updateModelWithBody);

}

function doGetCaretPosition (ctrl) {
	var CaretPos = 0;
	// IE Support
	if (document.selection) {
		ctrl.focus ();
		var Sel = document.selection.createRange ();
		Sel.moveStart ('character', -ctrl.value.length);
		CaretPos = Sel.text.length;
	}
	// Firefox support
	else if (ctrl.selectionStart || ctrl.selectionStart == '0')
		CaretPos = ctrl.selectionStart;
	return (CaretPos);
}

function beautify() {
	editor.setValue(js_beautify(editor.getValue()));
}


var data = {
	"requestTemplates": [{
		"id": "simpleText.request",
		"protocol": "http",
		"host": {
			"$config": "simpleText.hostname"
		}
	}, {
		"id": "simpleText.request.postBody",
		"headers": {
			"content-type": "application/json"
		},
		"body": {
			"title": "Test Title",
			"type": "HTML",
			"description": "This is a test simpleText",
			"text": "<p>hello world</p>",
			"authors": [{
				"id": "fnord",
				"firstName": "fnord",
				"lastName": "opus"
			}]
		}
	}, {
		"id": "simpleText.request.invalidPostBody",
		"headers": {
			"content-type": "application/json"
		},
		"body": {
			"title": [1234]
		}
	}, {
		"id": "simpleText.request.putBody",
		"headers": {
			"content-type": "application/json"
		},
		"body": {
			"id": "${simpleTextId}",
			"title": "Test Title",
			"type": "HTML",
			"description": "This is an updated test simpleText",
			"text": "<p>hello world</p>",
			"authors": [{
				"id": "fnord",
				"firstName": "fnord",
				"lastName": "opus"
			}]
		}
	}],
	"responseTemplates": [{
		"id": "ok.simpleText",
		"statusCode": 200,
		"headers": {
			"content-type": "application/json"
		},
		"body": {
			"id": "${simpleTextId}",
			"title": { "$exists": true },
			"description": { "$exists": true },
			"createdDate": { "$exists": true }
		}
	}, {
		"id": "notFound.simpleText",
		"statusCode": 404
	}, {
		"id": "methodNotAllowed.simpleText",
		"statusCode": 405
	}, {
		"id": "created.simpleText",
		"statusCode": 201,
		"headers": {
			"location": {
				"$exists": true
			}
		}
	}, {
		"id": "noContent.simpleText",
		"statusCode": 204
	}, {
		"id": "badRequest.simpleText",
		"statusCode": 400
	}],
	"setupAndTeardowns": [{
		"id": "create.simpleText",
		"request": {
			"templates": ["simpleText.request", "simpleText.request.postBody"],
			"method": "POST",
			"resource": "/simpleTexts",
			"headers": {}
		},
		"expectedResponse": {
			"templates": ["created.simpleText"]
		},
		"actions": [{
			"$set": {
				"simpleTextResource": {
					"$replace" : {
						"field": "headers.location",
						"regex": "^.*(/simpleTexts/.+)$",
						"replacement": "$1"
					}
				},
				"simpleTextId": {
					"$replace" : {
						"field": "headers.location",
						"regex": "^.*/simpleTexts/(.+)$",
						"replacement": "$1"
					}
				}
			}
		}]
	}, {
		"id": "delete.simpleText",
		"request": {
			"templates": ["simpleText.request"],
			"method": "DELETE",
			"resource": "${simpleTextResource}",
			"headers": {}
		},
		"expectedResponse": {
			"templates": ["noContent.simpleText"]
		}
	}],
	"tests": [{
		"id": "POST_simpletexts_200",
		"setup": [],
		"teardown": ["delete.simpleText"],
		"request": {
			"templates": ["simpleText.request", "simpleText.request.postBody"],
			"method": {
				"value": "POST",
				"inheritedValue": "GET",
				"inheritedFrom": "simpleText.request",
				"bgcolor": "transparent"
			},
			"protocol": {
				"value": "https",
				"inheritedValue": "http",
				"inheritedFrom": "simpleText.request.postBody"
			},
			"host": {
				"value": "m-api.ecollege.com",
				"inheritedValue": "m-api.ecollege.com",
				"inheritedFrom": "simpleText.request.postBody"
			},
			"resource": {
				"value": "/simpleTexts",
				"inheritedValue": "/simpleTexts-inherited",
				"inheritedFrom": "simpleText.request"
			},
			"headers": [{
				"key": "content-type",
				"value": "application/json",
				"inheritedKey": "content-type",
				"inheritedValue": "application/json",
				"inheritedFrom": "simpleText.request"
			}, {
				"key": "testHeader",
				"value": "testValue"
			}],
			"body": {
				"value": {
					"id": "${simpleTextId}",
					"title": "Test Title",
					"type": "HTML",
					"description": "This is an updated test simpleText",
					"text": "<p>hello world</p>",
					"authors": [{
							"id": "fnord",
							"firstName": "fnord",
							"lastName": "opus"
						}
					]
				}
			}
		},
		"expectedResponse": {
			"templates": ["created.simpleText"]
		},
		"actions": [{
			"$set": {
				"simpleTextResource": {
					"$replace" : {
						"field": "headers.location",
						"regex": "^.*(/simpleTexts/.+)$",
						"replacement": "$1"
					}
				}
			}
		}]
	}, {
		"id": "POST_simpleTexts_400",
		"setup": [],
		"teardown": [],
		"request": {
			"templates": ["simpleText.request", "simpleText.request.invalidPostBody"],
			"method": "POST",
			"resource": "/simpleTexts"
		},
		"expectedResponse": {
			"templates": ["badRequest.simpleText"]
		}
	}, {
		"id": "GET /simpleTexts/{id} 200",
		"setup": ["create.simpleText"],
		"teardown": ["delete.simpleText"],
		"request": {
			"templates": ["simpleText.request"],
			"method": "GET",
			"resource": "${simpleTextResource}"
		},
		"expectedResponse": {
			"templates": ["ok.simpleText"]
		}
	}, {
		"id": "GET_simpleTexts_405",
		"setup": [],
		"teardown": [],
		"request": {
			"templates": ["simpleText.request"],
			"method": "GET",
			"resource": "/simpleTexts"
		},
		"expectedResponse": {
			"templates": ["methodNotAllowed.simpleText"]
		}
	}, {
		"id": "GET /simpleTexts/{id} 404",
		"setup": [],
		"teardown": [],
		"request": {
			"templates": ["simpleText.request"],
			"method": "GET",
			"resource": "/simpleTexts/fnord"
		},
		"expectedResponse": {
			"templates": ["notFound.simpleText"]
		}
	}, {
		"id": "PUT /simpleTexts/{id} 200",
		"setup": ["create.simpleText"],
		"teardown": ["delete.simpleText"],
		"request": {
			"templates": ["simpleText.request", "simpleText.request.putBody"],
			"method": "PUT",
			"resource": "${simpleTextResource}"
		},
		"expectedResponse": {
			"templates": ["noContent.simpleText"]
		}
	}, {
		"id": "PUT /simpleTexts/{id} 400",
		"setup": ["create.simpleText"],
		"teardown": ["delete.simpleText"],
		"request": {
			"templates": ["simpleText.request", "simpleText.request.invalidPostBody"],
			"method": "PUT",
			"resource": "${simpleTextResource}"
		},
		"expectedResponse": {
			"templates": ["badRequest.simpleText"]
		}
	}, {
		"id": "DELETE /simpleTexts/{id} 200",
		"setup": ["create.simpleText"],
		"teardown": [],
		"request": {
			"templates": ["simpleText.request"],
			"method": "DELETE",
			"resource": "${simpleTextResource}"
		},
		"expectedResponse": {
			"templates": ["noContent.simpleText"]
		}
	}, {
		"id": "DELETE /simpleTexts/{id} 404",
		"setup": [],
		"teardown": [],
		"request": {
			"templates": ["simpleText.request"],
			"method": "DELETE",
			"resource": "/simpleTexts/fnord"
		},
		"expectedResponse": {
			"templates": ["notFound.simpleText"]
		}
	}]
};
</script>
</html>